<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null), title: 'Profile' }) %>

<div class="container mt-5 mb-5 profile-wrapper">
  <div class="profile-shell">
    <header class="profile-header d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div>
        <p class="profile-kicker mb-1"><%= user && user.role === 'admin' ? 'Admin account' : 'Customer account' %></p>
        <h2 class="profile-title mb-0">Account profile</h2>
      </div>
    </header>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(e){ %>
          <div><%= e %></div>
        <% }) %>
      </div>
    <% } %>
    <% if (messages && messages.length) { %>
      <div class="alert alert-success">
        <% messages.forEach(function(m){ %>
          <div><%= m %></div>
        <% }) %>
      </div>
    <% } %>

    <div class="row g-4">
      <div class="col-md-6">
        <section class="profile-card h-100">
          <h3 class="profile-section-title mb-3">Profile details</h3>
          <form action="/profile" method="POST">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" name="username" class="form-control" value="<%= formData && formData.username ? formData.username : (user && user.username) %>" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control" value="<%= formData && formData.email ? formData.email : (user && user.email) %>" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Address</label>
              <textarea name="address" class="form-control" rows="2"><%= formData && formData.address ? formData.address : (user && user.address) %></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Contact</label>
              <input type="text" name="contact" class="form-control" value="<%= formData && formData.contact ? formData.contact : (user && user.contact) %>">
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <span class="profile-role-label">Role: <strong><%= user && user.role %></strong></span>
              <button type="submit" class="btn btn-dark">Save changes</button>
            </div>
          </form>
        </section>
      </div>

      <div class="col-md-6">
        <section class="profile-card h-100">
          <h3 class="profile-section-title mb-3">Change password</h3>

          <% if (passwordStep === 'otp') { %>
            <p class="small text-muted mb-3">We have generated a one-time code for this password change. Enter it below to confirm.</p>
            <% if (otpHint) { %>
              <p class="small profile-otp-hint mb-3">Demo OTP code: <strong><%= otpHint %></strong></p>
            <% } %>
            <form action="/profile/password/confirm" method="POST">
              <div class="mb-3">
                <label class="form-label">One-time code (OTP)</label>
                <input type="text" name="otp" class="form-control" maxlength="6" required>
              </div>
              <button type="submit" class="btn btn-dark">Confirm new password</button>
            </form>
          <% } else { %>
            <p class="small text-muted mb-3">For security, well first verify your current password, then send a one-time code for confirmation.</p>
            <form action="/profile/password/request-otp" method="POST">
              <div class="mb-3">
                <label class="form-label">Current password</label>
                <input type="password" name="currentPassword" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">New password</label>
                <input type="password" name="newPassword" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm new password</label>
                <input type="password" name="newPassword2" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-dark">Continue</button>
            </form>
          <% } %>
        </section>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

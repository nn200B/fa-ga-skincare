<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null), title: 'Cart' }) %>

  <!-- Cart Content -->
  <div class="container mt-5 mb-5 cart-wrapper">
    <div class="cart-shell">
      <header class="cart-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="cart-logo-pill">
            <span class="cart-logo-icon">âœ§</span>
          </div>
          <div>
            <p class="cart-kicker mb-1">Your selected rituals</p>
            <h2 class="cart-title mb-0">Shopping cart</h2>
          </div>
        </div>
      </header>

      <% if (!cart || cart.length === 0) { %>
        <p class="mt-4 mb-0">Your cart is empty.</p>
      <% } else { %>
        <% let total = 0; %>
        <form id="cartCheckoutForm" action="/cart/selection" method="POST">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll">
              <label class="form-check-label" for="selectAll">Select all</label>
            </div>
          </div>

          <div class="cart-items">
            <% cart.forEach(function(item){
                 const pid = item.productId;
                 const line = Number(item.price || 0) * Number(item.quantity || 0);
                 total += line;
            %>
              <article class="cart-item" data-pid="<%= pid %>">
                <div class="cart-item-select">
                  <input type="checkbox" name="selected" value="<%= pid %>" class="form-check-input item-checkbox">
                </div>
                <div class="cart-item-media">
                  <% if (item.image) { %>
                    <div class="cart-item-thumb-wrap">
                      <img src="/images/<%= item.image %>" alt="<%= item.productName %>" class="cart-item-thumb">
                    </div>
                  <% } else { %>
                    <div class="cart-item-thumb-wrap cart-item-thumb-empty"></div>
                  <% } %>
                </div>
                <div class="cart-item-main">
                  <h3 class="cart-item-name mb-1"><%= item.productName %></h3>
                  <p class="cart-item-price mb-1">$<%= Number(item.price || 0).toFixed(2) %> each</p>
                  <form action="/cart/update" method="POST" class="cart-qty-form d-flex align-items-center gap-2 mt-1">
                    <input type="hidden" name="productId" value="<%= pid %>">
                    <label class="mb-0 small text-muted">Qty</label>
                    <input
                      type="number"
                      name="quantity"
                      class="form-control form-control-sm cart-qty-input"
                      value="<%= item.quantity %>"
                      min="1"
                    >
                    <button type="submit" class="btn btn-sm btn-outline-dark">Update</button>
                  </form>
                </div>
                <div class="cart-item-side text-end">
                  <div class="cart-item-line">
                    $<span class="line-amount"><%= line.toFixed(2) %></span>
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm mt-2 delete-btn"
                    data-pid="<%= pid %>"
                    data-pname="<%= (item.productName || '').replace(/\"/g, '&quot;') %>"
                    data-line="<%= line.toFixed(2) %>"
                  >
                    Delete
                  </button>
                </div>
              </article>
            <% }) %>
          </div>
        </form>

        <footer class="cart-footer d-flex flex-wrap align-items-center gap-3 mt-4">
          <div class="cart-total">
            <span class="cart-total-label">Total</span>
            <span class="cart-total-amount">$<span id="cartTotal"><%= total.toFixed(2) %></span></span>
          </div>
          <div class="ms-auto d-flex flex-wrap gap-2">
            <a href="/shopping" class="btn btn-outline-secondary">Back to shopping</a>
            <button id="proceedSelectedBtn" type="button" class="btn btn-primary">Proceed with selected</button>
            <form id="clearCartForm" action="/cart/clear" method="POST">
              <button type="submit" class="btn btn-outline-danger">Clear cart</button>
            </form>
          </div>
        </footer>
      <% } %>
    </div>
  </div>

  <!-- Delete confirmation modal (no form submit) -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="modalBodyText">Are you sure you want to remove this item from your cart?</p>
        </div>
        <div class="modal-footer">
          <button id="cancelDeleteBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toastContainer"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // helper: show bootstrap toast
  function showToast(message, title, variant) {
    const container = document.getElementById('toastContainer');
    if (!container) return; // fail-safe
    const id = 't' + Date.now();
    const toastHtml = `
      <div id="${id}" class="toast align-items-center text-bg-${variant || 'primary'} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    container.insertAdjacentHTML('beforeend', toastHtml);
    const el = document.getElementById(id);
    const bs = new bootstrap.Toast(el, { delay: 3000 });
    bs.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  let deleteModal = null;
  let deleteTargetPid = null;
  let deleteTargetLine = 0;

  function openConfirmModal(productId, productName, lineAmount) {
    deleteTargetPid = String(productId);
    deleteTargetLine = Number(lineAmount || 0);
    document.getElementById('modalBodyText').textContent =
      'Are you sure you want to remove "' + productName + '" from your cart?';
    if (!deleteModal) {
      deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
      document.getElementById('confirmDeleteBtn').addEventListener('click', doDelete);
    }
    deleteModal.show();
  }

  async function doDelete() {
    if (!deleteTargetPid) return;
    try {
      const resp = await fetch('/cart/delete/' + encodeURIComponent(deleteTargetPid), {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      console.log('DEBUG delete response status=', resp.status);
      const data = await resp.json();
      console.log('DEBUG delete response body=', data);
      if (data && data.success) {
        // remove row from DOM
        const row = document.querySelector('tr[data-pid="' + CSS.escape(deleteTargetPid) + '"]');
        if (row) row.remove();

        // update total shown
        const totalSpan = document.getElementById('cartTotal');
        if (totalSpan) {
          const curr = parseFloat(totalSpan.textContent || '0') || 0;
          const next = Math.max(0, curr - deleteTargetLine);
          totalSpan.textContent = next.toFixed(2);
        }

        // if cart empty, hide items and show message
        const remainingItems = document.querySelectorAll('.cart-item');
        if (!remainingItems || remainingItems.length === 0) {
          const shell = document.querySelector('.cart-shell');
          if (shell) {
            shell.innerHTML = '<p class="mt-4 mb-0">Your cart is empty.</p>';
          }
        }
      } else {
        console.error('Delete failed', data);
        showToast('Could not remove item. Try again.', 'Error', 'danger');
      }
    } catch (err) {
      console.error('Delete request failed', err);
      showToast('Network error. Try again.', 'Error', 'danger');
    } finally {
      if (deleteModal) deleteModal.hide();
      deleteTargetPid = null;
      deleteTargetLine = 0;
    }
  }

  // Wire up delete buttons (use data- attributes to avoid inline JS in template)
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.delete-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        const pid = btn.dataset.pid;
        const pname = btn.dataset.pname || '';
        const line = btn.dataset.line || '0';
        openConfirmModal(pid, pname, line);
      });
    });

    // Select-all behaviour for cart checkboxes
    const selectAll = document.getElementById('selectAll');
    const itemCheckboxes = Array.from(document.querySelectorAll('.item-checkbox'));
    if (selectAll && itemCheckboxes.length) {
      selectAll.addEventListener('change', function(){
        itemCheckboxes.forEach(cb => { cb.checked = selectAll.checked; });
      });
      itemCheckboxes.forEach(cb => {
        cb.addEventListener('change', function(){
          if (!cb.checked) selectAll.checked = false;
          else if (itemCheckboxes.every(x => x.checked)) selectAll.checked = true;
        });
      });
    }

    // Proceed with selected items
    const proceedBtn = document.getElementById('proceedSelectedBtn');
    const form = document.getElementById('cartCheckoutForm');
    if (proceedBtn && form) {
      proceedBtn.addEventListener('click', function(){
        const checked = form.querySelectorAll('.item-checkbox:checked');
        if (!checked.length) {
          showToast('Please select item(s) to check out.', 'Error', 'danger');
          return;
        }
        form.submit();
      });
    }

    // Tiny bump animation when quantity form submits
    document.querySelectorAll('.cart-qty-form').forEach(function(f){
      f.addEventListener('submit', function(){
        const item = f.closest('.cart-item');
        if (!item) return;
        const lineEl = item.querySelector('.cart-item-line');
        if (!lineEl) return;
        lineEl.classList.remove('is-updated');
        void lineEl.offsetWidth; // force reflow to restart animation
        lineEl.classList.add('is-updated');
      });
    });
  });
</script>
<script>
  // Show failure prompt if redirected with ?paymentFailed=1
  (function(){
    const params = new URLSearchParams(window.location.search);
    if (params.get('paymentFailed') === '1') {
      alert('Payment was unsuccessful, please try again or another payment method.');
      if (window.history && window.history.replaceState) {
        params.delete('paymentFailed');
        const cleaned = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
        window.history.replaceState({}, '', cleaned);
      }
    }
  })();
</script>
<%- include('partials/footer') %>

<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null), title: 'Checkout' }) %>

<div class="container mt-4">
  <h2>Checkout</h2>

  <% var errors = (typeof errors !== 'undefined' && Array.isArray(errors)) ? errors : []; %>
  <% var success = (typeof success !== 'undefined' && Array.isArray(success)) ? success : []; %>

  <% if (errors.length) { %>
    <div class="alert alert-danger"><%= errors.join('<br>') %></div>
  <% } %>
  <% if (success.length) { %>
    <div class="alert alert-success"><%= success.join('<br>') %></div>
  <% } %>

  <h4>Items</h4>
  <ul class="list-group mb-3">
    <% (cart || []).forEach(function(item){ %>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong><%= item.productName %></strong>
          <div class="text-muted">Qty: <%= item.quantity %> &middot; $<%= Number(item.price || 0).toFixed(2) %></div>
        </div>
        <div>
          $<%= (Number(item.price || 0) * Number(item.quantity || 0)).toFixed(2) %>
        </div>
      </li>
    <% }) %>
  </ul>

  <h4>Subtotal: $<%= subtotal.toFixed(2) %></h4>

  <% if (typeof membership !== 'undefined') { %>
    <div class="alert alert-light border membership-checkout-box mt-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <div class="fw-semibold">GlowAura Membership</div>
          <div class="small text-muted">Tier: <strong><%= membership.tierName %></strong> Â· Points: <strong><%= membership.points %></strong></div>
        </div>
        <div class="text-end">
          <div class="small">Progress to <%= membership.nextTierName || membership.tierName %>: <%= membership.progressPercent %>%</div>
          <div class="membership-mini-bar mt-1">
            <div class="membership-mini-fill" style="width:<%= membership.progressPercent %>%;"></div>
          </div>
        </div>
      </div>
      <hr class="my-2" />
      <div class="form-check small">
        <input class="form-check-input" type="checkbox" name="usePointsFreeDelivery" id="usePointsFreeDelivery" value="1" <%= (membership.points >= membership.redeemCostFreeDelivery ? '' : 'disabled') %>>
        <label class="form-check-label" for="usePointsFreeDelivery">
          Redeem <strong><%= membership.redeemCostFreeDelivery %> points</strong> for <strong>free normal delivery</strong> on this order.
          <% if (membership.points < membership.redeemCostFreeDelivery) { %>
            <span class="text-muted"> You need <%= membership.redeemCostFreeDelivery - membership.points %> more points.</span>
          <% } %>
        </label>
      </div>
    </div>
  <% } %>

  <% if (delivery) { %>
    <h5 class="mt-3">Delivery to</h5>
    <p>
      <strong><%= delivery.fullName %></strong><br>
      <%= delivery.street %><% if (delivery.unit) { %>, #<%= delivery.unit %><% } %><br>
      <%= delivery.postalCode %><br>
      <% if (delivery.note) { %>
        <span class="text-muted">Note: <%= delivery.note %></span>
      <% } %>
    </p>
  <% } %>

  <form method="post" action="/checkout">
    <div class="mb-3 mt-3">
      <label class="form-label">Delivery option</label>
      <select name="deliveryOption" class="form-select">
        <option value="normal">Normal (3 business days) - $10</option>
        <option value="one-day">One-day (next business day if before 1pm) - $25</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Payment method</label>
      <!-- Decouple select name; use hidden input for actual submission value -->
      <select id="paymentMethod" name="pmSelect" class="form-select">
        <option value="paypal" selected>PayPal</option>
        <option value="nets">NETS QR Code</option>
      </select>
    </div>

    <div id="paypal-button-container"></div>
    <div id="nets-button-container" class="mt-2" style="display:none;">
      <button type="submit" class="btn btn-dark">Pay with NETS QR</button>
    </div>

    <!-- Sync membership checkbox value into form for non-PayPal flows -->
    <input type="hidden" id="usePointsFreeDeliveryHidden" name="usePointsFreeDelivery" value="">
    <!-- Hidden payment method used for submission -->
    <input type="hidden" id="paymentMethodHidden" name="paymentMethod" value="paypal">
    <div class="mt-3">
      <a href="/cart" class="btn btn-secondary">Back to cart</a>
    </div>
  </form>
</div>

<script>
  // Show failure alert if redirected with ?paymentFailed=1
  (function(){
    const params = new URLSearchParams(window.location.search);
    if (params.get('paymentFailed') === '1') {
      alert('Payment Failed, please try again or another payment method.');
      // remove the param from the URL without reloading
      if (window.history && window.history.replaceState) {
        params.delete('paymentFailed');
        const cleaned = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
        window.history.replaceState({}, '', cleaned);
      }
    }
  })();

  // Toggle payment UIs and keep membership checkbox in sync for form submits
  (function(){
    const methodSelect = document.getElementById('paymentMethod');
    const paypalContainer = document.getElementById('paypal-button-container');
    const netsContainer = document.getElementById('nets-button-container');
    const usePointsEl = document.getElementById('usePointsFreeDelivery');
    const hiddenUsePoints = document.getElementById('usePointsFreeDeliveryHidden');
    const hiddenPayment = document.getElementById('paymentMethodHidden');

    function syncUsePoints(){
      if (!hiddenUsePoints) return;
      hiddenUsePoints.value = (usePointsEl && usePointsEl.checked) ? '1' : '';
    }
    syncUsePoints();
    if (usePointsEl) usePointsEl.addEventListener('change', syncUsePoints);

    function toggleUI(){
      const v = methodSelect ? methodSelect.value : 'paypal';
      if (hiddenPayment) hiddenPayment.value = v;
      if (v === 'nets') {
        netsContainer && (netsContainer.style.display = 'block');
        paypalContainer && (paypalContainer.style.display = 'none');
      } else {
        netsContainer && (netsContainer.style.display = 'none');
        paypalContainer && (paypalContainer.style.display = 'block');
      }
    }
    if (methodSelect) methodSelect.addEventListener('change', toggleUI);
    toggleUI();
  })();
</script>

<% if (typeof paypalClientId === 'string' && paypalClientId) { %>
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency || 'SGD' %>&intent=capture"></script>
  <script>
    (function(){
      const deliverySelect = document.querySelector('select[name="deliveryOption"]');
      const usePointsEl = document.getElementById('usePointsFreeDelivery');
      const container = document.getElementById('paypal-button-container');
      if (!(window.paypal && container)) return;

      paypal.Buttons({
        createOrder: function(data, actions) {
          const deliveryOption = deliverySelect ? deliverySelect.value : 'normal';
          const usePointsFreeDelivery = !!(usePointsEl && usePointsEl.checked);
          return fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deliveryOption, usePointsFreeDelivery })
          }).then(function(res){ return res.json(); })
            .then(function(json){
              if (!json || !json.id) throw new Error('Failed to create order');
              return json.id;
            }).catch(function(e){
              console.error('createOrder error', e);
              window.location.href = '/checkout?paymentFailed=1';
            });
        },
        onApprove: function(data, actions) {
          const orderID = data.orderID;
          return fetch('/api/paypal/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderID })
          }).then(function(res){ return res.json(); })
            .then(function(json){
              if (!json || !json.success) throw new Error('Capture failed');
              window.location.href = json.redirect || ('/orders/' + (json.orderId || ''));
            }).catch(function(e){
              console.error('capture error', e);
              window.location.href = '/checkout?paymentFailed=1';
            });
        },
        onError: function(err){
          console.error('PayPal error', err);
          window.location.href = '/checkout?paymentFailed=1';
        },
        onCancel: function(){
          // User cancelled, just return to checkout silently
        }
      }).render('#paypal-button-container');
    })();
  </script>
<% } else { %>
  <div class="alert alert-warning mt-3">PayPal is not configured. Please set PAYPAL_CLIENT_ID.</div>
<% } %>

<%- include('partials/footer') %>

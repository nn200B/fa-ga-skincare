<%- include('partials/header', { title: 'Register' }) %>

<div class="auth-wrapper">
    <div class="auth-card register-card">
        <div class="auth-illustration d-none d-md-flex">
            <div>
                <h2 class="brand-title">Join GlowAura Society</h2>
                <p class="brand-subtitle">Create a member profile to unlock curated, luxury skincare.</p>
                <ul class="auth-highlights">
                    <li>✔ Tailored rituals for your skin type</li>
                    <li>✔ Priority access to limited collections</li>
                    <li>✔ Complimentary samples with every order</li>
                </ul>
            </div>
        </div>
        <div class="auth-form">
            <h1 class="auth-heading">Create your GlowAura ID</h1>
            <p class="auth-text">Fill in your details to begin your skincare journey.</p>

            <% if (messages && messages.length > 0) { %>
                <div class="alert alert-danger mb-3">
                    <% messages.forEach(function(message) { %>
                        <div><%= message %></div>
                    <% }); %>
                </div>
            <% } %>

            <form id="registerForm" action="/register" method="POST" class="mt-3">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" name="username" class="form-control form-control-lg" required
                        value="<%= formData && formData.username ? formData.username : '' %>">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" id="email" name="email" class="form-control form-control-lg" required
                        value="<%= formData && formData.email ? formData.email : '' %>">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" name="password" class="form-control form-control-lg" required>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <input type="text" id="address" name="address" class="form-control form-control-lg" required
                        value="<%= formData && formData.address ? formData.address : '' %>">
                </div>
                <div class="mb-3">
                    <label for="contact" class="form-label">Contact Number</label>
                    <input type="text" id="contact" name="contact" class="form-control form-control-lg" required
                        value="<%= formData && formData.contact ? formData.contact : '' %>">
                </div>
                <div class="mb-3">
                    <label for="role" class="form-label">Role</label>
                    <select id="role" name="role" class="form-select form-select-lg" required>
                        <option value="user" <%= formData && formData.role === 'user' ? 'selected' : '' %>>User</option>
                        <option value="admin" <%= formData && formData.role === 'admin' ? 'selected' : '' %>>Admin</option>
                    </select>
                </div>

                <!-- Biometric scan mimic -->
                <div class="mb-3 mt-4">
                    <label class="form-label d-flex justify-content-between align-items-center">
                        <span>Biometric verification (face scan)</span>
                        <span class="small text-muted" id="bio-status-label">Not verified</span>
                    </label>
                    <div class="border rounded-3 p-3 d-flex flex-column align-items-center justify-content-center" style="background: #020617; color:#e5e7eb;">
                        <div class="bio-face-frame mb-3">
                            <video id="bioVideo" class="bio-video" autoplay playsinline muted></video>
                            <div class="bio-face-outline"></div>
                            <div class="bio-face-grid"></div>
                            <div class="bio-scan-line"></div>
                        </div>
                        <p class="small mb-2" id="bio-instruction">Align your face inside the frame and start scan</p>
                        <button type="button" id="startBioScan" class="btn btn-outline-light btn-sm px-4">Start face scan</button>
                    </div>
                </div>

                <button id="registerSubmit" type="submit" class="btn btn-success w-100 btn-lg" disabled>Complete biometric scan to continue</button>
            </form>

            <p class="auth-footer-text mt-3">Already have an account?
                <a href="/login">Sign in instead</a>
            </p>
        </div>
    </div>
</div>

<script>
    (function(){
        const startBtn = document.getElementById('startBioScan');
        const statusLabel = document.getElementById('bio-status-label');
        const instruction = document.getElementById('bio-instruction');
        const submitBtn = document.getElementById('registerSubmit');
        const frame = document.querySelector('.bio-face-frame');
        const video = document.getElementById('bioVideo');

        if (!startBtn || !statusLabel || !instruction || !submitBtn || !frame) return;

        let scanning = false;
        let completed = false;
        let activeStream = null;

        startBtn.addEventListener('click', function(){
            if (scanning || completed) return;
            scanning = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Starting camera...';

            const startFakeScan = function(){
                submitBtn.textContent = 'Scanning face...';
                statusLabel.textContent = 'Scanning';
                instruction.textContent = 'Keep your face inside the frame while we verify...';
                frame.classList.add('is-scanning');

                setTimeout(function(){
                    frame.classList.remove('is-scanning');
                    frame.classList.add('is-verified');
                    statusLabel.textContent = 'Verified';
                    instruction.textContent = 'Biometric check completed successfully. Camera can now be closed.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create account';
                    completed = true;
                    startBtn.disabled = true;
                    startBtn.textContent = 'Scan completed';
                    if (activeStream) {
                        activeStream.getTracks().forEach(function(track){ track.stop(); });
                        activeStream = null;
                    }
                    scanning = false;
                }, 2800);
            };

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && video) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(function(stream){
                    activeStream = stream;
                    try {
                        video.srcObject = stream;
                    } catch (e) {
                        video.src = window.URL.createObjectURL(stream);
                    }
                    video.play().catch(function(){});
                    startFakeScan();
                }).catch(function(){
                    instruction.textContent = 'Camera permission denied. Proceeding with simulated scan only.';
                    startFakeScan();
                });
            } else {
                instruction.textContent = 'Camera not available. Proceeding with simulated scan only.';
                startFakeScan();
            }
        });
    })();
</script>

<style>
    .bio-face-frame{
        width:132px;
        height:132px;
        border-radius:22px;
        border:2px solid rgba(148, 163, 184, 0.8);
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
        overflow:hidden;
    }
    .bio-video{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        object-fit:cover;
        filter:brightness(0.9) contrast(1.05) saturate(1.1);
    }
    .bio-face-outline{
        width:86px;
        height:106px;
        border-radius:46px;
        border:2px solid rgba(56,189,248,0.9);
        box-shadow:0 0 24px rgba(56,189,248,0.85);
        position:relative;
    }
    .bio-face-outline::before,
    .bio-face-outline::after{
        content:"";
        position:absolute;
        inset:10px;
        border-radius:40px;
        border:1px solid rgba(56,189,248,0.5);
    }
    .bio-face-outline::after{
        inset:22px 18px 16px 18px;
        border-radius:32px;
        border-color:rgba(56,189,248,0.28);
    }
    .bio-face-grid{
        position:absolute;
        inset:16px;
        background-image:
            linear-gradient(to right, rgba(148,163,184,0.25) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(148,163,184,0.25) 1px, transparent 1px);
        background-size:14px 14px;
        opacity:0.6;
    }
    .bio-scan-line{
        position:absolute;
        left:12px;
        right:12px;
        height:2px;
        background:linear-gradient(90deg, transparent, #38bdf8, transparent);
        box-shadow:0 0 18px rgba(56,189,248,0.9);
        transform:translateY(-80px);
        opacity:0;
    }
    .bio-face-frame.is-scanning .bio-scan-line{
        opacity:1;
        animation:faceScan 1.8s ease-in-out infinite;
    }
    .bio-face-frame.is-verified{
        border-color:#22c55e;
        box-shadow:0 0 22px rgba(34,197,94,0.7);
    }
    .bio-face-frame.is-verified .bio-face-outline{
        border-color:#22c55e;
        box-shadow:0 0 22px rgba(34,197,94,0.85);
    }
    @keyframes faceScan{
        0%{ transform:translateY(-80px);} 
        50%{ transform:translateY(80px);} 
        100%{ transform:translateY(-80px);} 
    }
</style>

<%- include('partials/footer') %>

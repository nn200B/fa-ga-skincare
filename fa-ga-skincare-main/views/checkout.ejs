<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null), title: 'Checkout' }) %>

<div class="container mt-4">
  <h2>Checkout</h2>

  <% var errors = (typeof errors !== 'undefined' && Array.isArray(errors)) ? errors : []; %>
  <% var success = (typeof success !== 'undefined' && Array.isArray(success)) ? success : []; %>

  <% if (errors.length) { %>
    <div class="alert alert-danger"><%= errors.join('<br>') %></div>
  <% } %>
  <% if (success.length) { %>
    <div class="alert alert-success"><%= success.join('<br>') %></div>
  <% } %>

  <h4>Items</h4>
  <ul class="list-group mb-3">
    <% (cart || []).forEach(function(item){ %>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong><%= item.productName %></strong>
          <div class="text-muted">Qty: <%= item.quantity %> &middot; $<%= Number(item.price || 0).toFixed(2) %></div>
        </div>
        <div>
          $<%= (Number(item.price || 0) * Number(item.quantity || 0)).toFixed(2) %>
        </div>
      </li>
    <% }) %>
  </ul>

  <h4>Subtotal: $<%= subtotal.toFixed(2) %></h4>

  <% if (typeof membership !== 'undefined') { %>
    <div class="alert alert-light border membership-checkout-box mt-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <div class="fw-semibold">GlowAura Membership</div>
          <div class="small text-muted">Tier: <strong><%= membership.tierName %></strong> Â· Points: <strong><%= membership.points %></strong></div>
        </div>
        <div class="text-end">
          <div class="small">Progress to <%= membership.nextTierName || membership.tierName %>: <%= membership.progressPercent %>%</div>
          <div class="membership-mini-bar mt-1">
            <div class="membership-mini-fill" style="width:<%= membership.progressPercent %>%;"></div>
          </div>
        </div>
      </div>
      <hr class="my-2" />
      <div class="form-check small">
        <input class="form-check-input" type="checkbox" name="usePointsFreeDelivery" id="usePointsFreeDelivery" value="1" <%= (membership.points >= membership.redeemCostFreeDelivery ? '' : 'disabled') %>>
        <label class="form-check-label" for="usePointsFreeDelivery">
          Redeem <strong><%= membership.redeemCostFreeDelivery %> points</strong> for <strong>free normal delivery</strong> on this order.
          <% if (membership.points < membership.redeemCostFreeDelivery) { %>
            <span class="text-muted"> You need <%= membership.redeemCostFreeDelivery - membership.points %> more points.</span>
          <% } %>
        </label>
      </div>
    </div>
  <% } %>

  <% if (delivery) { %>
    <h5 class="mt-3">Delivery to</h5>
    <p>
      <strong><%= delivery.fullName %></strong><br>
      <%= delivery.street %><% if (delivery.unit) { %>, #<%= delivery.unit %><% } %><br>
      <%= delivery.postalCode %><br>
      <% if (delivery.note) { %>
        <span class="text-muted">Note: <%= delivery.note %></span>
      <% } %>
    </p>
  <% } %>

  <div class="mb-3 mt-3">
    <label class="form-label">Delivery option</label>
    <select name="deliveryOption" id="deliveryOption" class="form-select">
      <option value="normal">Normal (3 business days) - $10</option>
      <option value="one-day">One-day (next business day if before 1pm) - $25</option>
    </select>
  </div>

  <div id="paypal-buttons" class="mt-3"></div>
  <div id="paypal-error" class="alert alert-warning mt-3" style="display:none"></div>
  <a href="/cart" class="btn btn-secondary mt-2">Back to cart</a>
</div>

<% if (paypalClientId) { %>
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency || 'SGD' %>"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const errorBox = document.getElementById('paypal-error');
      const deliverySelect = document.getElementById('deliveryOption');
      const usePointsCheckbox = document.getElementById('usePointsFreeDelivery');

      if (!window.paypal || !window.paypal.Buttons) {
        errorBox.textContent = 'PayPal SDK failed to load. Check your PAYPAL_CLIENT_ID and internet connection.';
        errorBox.style.display = '';
        return;
      }

      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'pay' },
        createOrder: function(data, actions){
          const payload = {
            deliveryOption: deliverySelect.value,
            usePointsFreeDelivery: usePointsCheckbox && usePointsCheckbox.checked ? '1' : '0'
          };
          return fetch('/api/paypal/order/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(res => {
            return res.json().then(d => ({ ok: res.ok, data: d }));
          }).then(({ ok, data }) => {
            if (ok && data && data.id) return data.id;
            throw new Error(data && data.error ? data.error : 'Failed to create order');
          }).catch(err => {
            errorBox.textContent = 'Payment Failed, please try again or another payment method.';
            errorBox.style.display = '';
            throw err;
          });
        },
        onApprove: function(data, actions){
          const payload = {
            orderID: data.orderID,
            deliveryOption: deliverySelect.value,
            usePointsFreeDelivery: usePointsCheckbox && usePointsCheckbox.checked ? '1' : '0'
          };
          return fetch('/api/paypal/order/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(res => {
            return res.json().then(d => ({ ok: res.ok, data: d }));
          }).then(({ ok, data }) => {
            if (!ok || (data && data.error)) {
              throw new Error(data && data.error ? data.error : 'Capture failed');
            }
            // Prefer direct redirect to order detail if available
            if (data && data.orderId) {
              window.location.href = '/orders/' + encodeURIComponent(data.orderId);
              return;
            }
            if (data && data.redirect) {
              window.location.href = data.redirect;
              return;
            }
            // Fallback to success flow
            window.location.href = '/payment-success';
          }).catch(err => {
            errorBox.textContent = 'Payment Failed, please try again or another payment method.';
            errorBox.style.display = '';
          });
        },
        onError: function(err){
          errorBox.textContent = 'Payment Failed, please try again or another payment method.';
          errorBox.style.display = '';
        }
      }).render('#paypal-buttons');
    });
  </script>
<% } else { %>
  <div class="alert alert-warning mt-3">PayPal is not configured. Please set PAYPAL_CLIENT_ID and PAYPAL_CLIENT_SECRET.</div>
<% } %>

<%- include('partials/footer') %>

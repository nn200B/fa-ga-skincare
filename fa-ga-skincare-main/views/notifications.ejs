<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null), title: 'Notifications' }) %>

<% var currentFilter = (typeof filter !== 'undefined' && filter) ? filter : 'all'; %>

<div class="container mt-5 mb-5 notifications-wrapper">
  <div class="notifications-shell">
    <header class="notifications-header d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div>
        <p class="notifications-kicker mb-1">Order & help center updates</p>
        <h2 class="notifications-title mb-0">Notifications</h2>
      </div>
      <% if (typeof totalUnread !== 'undefined' && totalUnread > 0) { %>
        <span class="badge rounded-pill notifications-unread-pill"><%= totalUnread %> unread</span>
      <% } %>
    </header>

  <% if (typeof errors !== 'undefined' && errors.length) { %>
    <div class="alert alert-danger">
      <ul class="mb-0">
        <% errors.forEach(function(e){ %>
          <li><%= e %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>
  <% if (typeof success !== 'undefined' && success.length) { %>
    <div class="alert alert-success">
      <ul class="mb-0">
        <% success.forEach(function(m){ %>
          <li><%= m %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <div class="notifications-filters mb-3 d-flex flex-wrap align-items-center gap-2">
    <div class="btn-group" role="group" aria-label="Filter notifications">
      <a href="/notifications?filter=all" class="btn btn-sm notifications-tab <%= (!currentFilter || currentFilter === 'all') ? 'active' : '' %>">All</a>
      <a href="/notifications?filter=unread" class="btn btn-sm notifications-tab <%= currentFilter === 'unread' ? 'active' : '' %>">Unread</a>
      <a href="/notifications?filter=read" class="btn btn-sm notifications-tab <%= currentFilter === 'read' ? 'active' : '' %>">Read</a>
    </div>
  </div>

  <div class="notifications-list">
    <% if (!notifications || !notifications.length) { %>
      <div class="notifications-empty text-muted">No notifications in this view yet.</div>
    <% } else { %>
      <% notifications.forEach(function(n){ %>
        <article class="notification-item <%= n.read ? 'is-read' : 'is-unread' %>">
          <a href="<%= n.link || '#' %>?notif=<%= n.id %>" class="notification-main">
            <div class="notification-badge"><%= (n.type || 'Update') %></div>
            <div class="notification-text">
              <p class="notification-message mb-1"><%= n.message %></p>
              <p class="notification-meta mb-0"><%= new Date(n.createdAt).toLocaleString('en-SG',{dateStyle:'short', timeStyle:'short'}) %></p>
            </div>
          </a>
          <div class="notification-actions text-end">
            <% if (!n.read) { %>
              <span class="badge notifications-new-pill mb-2">New</span>
              <form action="/notifications/<%= n.id %>/read" method="POST">
                <button class="btn btn-sm btn-outline-dark">Mark as read</button>
              </form>
            <% } else { %>
              <form action="/notifications/<%= n.id %>/unread" method="POST">
                <button class="btn btn-sm btn-outline-secondary">Mark as unread</button>
              </form>
            <% } %>
          </div>
        </article>
      <% }) %>
    <% } %>
  </div>

  </div>
</div>

<%- include('partials/footer') %>
